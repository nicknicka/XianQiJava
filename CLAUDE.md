# CLAUDE.md
本文件为 Claude Code (claude.ai/code) 提供项目上下文和开发指导。

---

## 项目概述

**校园二手交易与共享平台** - 面向高校学生的垂直化校园二手交易与物品共享平台，提供"交易+共享"双模式服务。

- **作者**：许佳宜
- **学号**：2022035123021
- **专业**：计算机科学与技术(职教师资)
- **指导教师**：温清机

---

## 项目目录 

后端 ： XianQiJava
uniapp ： XianQiUniapp

## 项目编写指南要求
项目下有一个todo清单，如果任务完成或者新建任务都需要在任务清单上标明，分类好

## 数据库名
Xianqi
### 数据库用户
root
### 数据库密码
123456

## 技术栈

### 后端
- **框架**：Spring Boot 4.0.2
- **Java 版本**：17
- **构建工具**：Maven (使用 Maven Wrapper)
- **数据库**：MySQL
- **缓存**：Redis
- **持久化**：MyBatis/MyBatis-Plus
- **API 文档**：Swagger/Knife4j
- **即时通讯**：WebSocket

### 前端
- **框架**：uniapp (跨端开发)
- **支持平台**：iOS、Android、微信小程序、H5

### 第三方服务
- **对象存储**：阿里云 OSS
- **地图服务**：高德地图/腾讯地图
- **内容安全**：阿里云/腾讯云内容审核 API

---

## 构建和开发命令

### 构建项目
```bash
./mvnw clean package
```

### 运行应用
```bash
./mvnw spring-boot:run
```

### 运行测试
```bash
# 所有测试
./mvnw test

# 单个测试类
./mvnw test -Dtest=XianqiApplicationTests

# 单个测试方法
./mvnw test -Dtest=XianqiApplicationTests#contextLoads
```

### 清理构建
```bash
./mvnw clean install
```

---

## 项目架构

### 整体架构
```
┌─────────────────────────────────────────────┐
│                用户端 (uniapp)               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  iOS/    │  │ Android/ │  │  微信    │  │
│  │  Android │  │   H5     │  │  小程序  │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└───────────────────┬─────────────────────────┘
                    │ HTTP/HTTPS
                    ▼
┌─────────────────────────────────────────────┐
│              后端服务 (SpringBoot)           │
│  ┌──────────────────────────────────────┐  │
│  │         Controller Layer             │  │
│  ├──────────────────────────────────────┤  │
│  │         Service Layer                │  │
│  ├──────────────────────────────────────┤  │
│  │         DAO Layer                    │  │
│  └──────────────────────────────────────┘  │
└───────────────────┬─────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │  MySQL   │ │   Redis  │ │  OSS/    │
  │ Database │ │  Cache   │ │  Local   │
  └──────────┘ └──────────┘ └──────────┘
```

### 包结构规划
```
com.xx.xianqi
├── controller          # 控制器层
├── service             # 服务层
│   └── impl           # 服务实现
├── mapper/dao          # 数据访问层
├── entity/model        # 数据库实体
├── dto                 # 数据传输对象
├── vo                  # 视图对象
├── config              # 配置类
├── interceptor         # 拦截器
├── filter              # 过滤器
├── exception           # 异常处理
├── util                # 工具类
├── enums               # 枚举类
├── annotation          # 自定义注解
├── websocket           # WebSocket 配置和处理器
└── XianqiApplication   # 启动类
```

---

## 核心功能模块

### 1. 用户管理模块 (P0)
- 用户注册/登录（学号认证、手机号）
- 个人信息管理
- 实名认证
- 用户中心（我的发布、订单、收藏、评价）
- 黑名单管理

### 2. 商品管理模块 (P0)
- 发布商品（图文、价格、成色、分类、位置）
- 商品编辑（上架/下架/已售）
- 商品检索（搜索、筛选、价格区间）
- 地理位置定位
- 商品收藏
- 浏览历史
- 智能推荐

### 3. 物品共享模块 (P1)
- 发布共享物品（押金、租金、可借用时间）
- 预约借用
- 借用审批
- 押金管理
- 归还确认
- 一键转赠

### 4. 交易订单模块 (P0)
- 创建订单
- 订单状态管理（待确认/进行中/已完成/已取消/已退款）
- 订单详情
- 订单评价
- 售后处理

### 5. 即时通讯模块 (P0)
- 即时聊天
- 消息推送
- 聊天记录
- 图片发送
- 商品卡片/订单卡片分享
- 引用回复
- 快捷回复
- 黑名单与举报

### 6. 信用评价模块 (P0)
- 交易评价（星级+文字+标签）
- 信用积分
- 信用等级
- 用户主页展示
- 好评率统计

### 7. 内容审核模块 (P0)
- 商品审核
- 违规处理
- 举报处理
- 敏感词过滤

### 8. 数据统计分析模块 (P1)
- 用户统计
- 交易统计
- 商品统计
- 数据可视化
- 报表导出

---

## 数据库设计概览

### 核心实体表 (17张)

#### 用户相关
- **user** - 用户表
- **blacklist** - 黑名单表

#### 商品相关
- **product** - 商品表
- **product_image** - 商品图片表（独立表，支持多尺寸）
- **product_favorite** - 商品收藏表
- **product_view_history** - 浏览历史表

#### 共享相关
- **share_item** - 共享物品表
- **share_item_image** - 共享物品图片表

#### 交易相关
- **order** - 订单表
- **evaluation** - 评价表

#### 聊天相关
- **conversation** - 会话表
- **message** - 消息表
- **conversation_member** - 会话成员表（群聊）
- **quick_reply** - 快捷回复模板表
- **report** - 举报记录表

#### 系统相关
- **category** - 分类表
- **system_notification** - 系统通知表
- **operation_log** - 操作日志表
- **system_config** - 系统配置表
- **sensitive_word** - 敏感词表
- **banner** - 轮播图表
- **user_feedback** - 用户反馈表

### 商品图片管理设计要点
- 每个商品最多 9 张图片
- 支持三种尺寸：原图、中等图(800x800)、缩略图(200x200)
- 使用 `is_cover` 字段标识封面图
- 使用 `sort_order` 字段控制排序
- 图片删除使用逻辑删除（status=1）

### 即时通讯设计要点
- 单聊场景：两个用户之间只有一个会话
- 群聊场景：使用 conversation_member 表管理成员
- 消息类型：文本、图片、商品卡片、订单卡片、引用消息、系统通知
- 消息状态：发送中、发送成功、发送失败
- 支持消息撤回（2分钟内）、引用回复、快捷回复

---

## API 接口规范

### 基础路径
- 用户端接口：`/api/*`
- 管理端接口：`/api/admin/*`
- 公开接口：`/api/public/*`

### 响应格式
```json
{
  "code": 200,
  "message": "成功",
  "data": {}
}
```

### HTTP 状态码
- **200** - 请求成功
- **201** - 创建成功
- **400** - 请求参数错误
- **401** - 未登录/Token无效
- **403** - 无权限访问
- **404** - 资源不存在
- **500** - 服务器内部错误

### 业务错误码
- **10001** - 用户名已存在
- **10002** - 手机号已注册
- **10003** - 密码错误
- **10004** - 用户已被封禁
- **20001** - 商品不存在
- **20002** - 商品已下架
- **20003** - 商品已售出
- **30001** - 订单不存在
- **30002** - 订单状态错误
- **40001** - 会话不存在
- **40002** - 消息已撤回
- **50001** - 敏感词违规
- **50002** - 图片审核不通过

### 主要接口模块
1. 用户相关：`/api/user/*`
2. 商品相关：`/api/product/*`、`/api/product-image/*`
3. 共享物品：`/api/share-item/*`、`/api/share-item-image/*`
4. 订单相关：`/api/order/*`
5. 评价相关：`/api/evaluation/*`
6. 聊天相关：`/api/conversation/*`、`/api/message/*`
7. 收藏相关：`/api/favorite/*`
8. 浏览历史：`/api/history/*`
9. 系统通知：`/api/notification/*`
10. 轮播图：`/api/banner/*`
11. 用户反馈：`/api/feedback/*`
12. 快捷回复：`/api/quick-reply/*`
13. 黑名单：`/api/blacklist/*`
14. 举报：`/api/report/*`

---

## WebSocket 实时通信

### 连接地址
```
wss://api.example.com/ws?token={jwt_token}
```

### 事件类型
- **message** - 接收新消息
- **message_read** - 消息已读回执
- **message_delivered** - 消息已送达
- **message_recalled** - 消息已撤回
- **typing** - 输入状态提示
- **online** - 在线状态通知
- **unread_count** - 未读数更新

---

## 系统配置

### 配置分组 (system_config 表)
- **basic** - 基础配置（应用名称、版本号、ICP备案号）
- **upload** - 上传配置（最大文件大小、允许类型、OSS配置）
- **payment** - 支付配置（支付宝、微信支付）
- **email** - 邮件配置（SMTP服务器）
- **sms** - 短信配置（短信服务商、模板ID）
- **security** - 安全配置（密码长度、Token过期时间）
- **business** - 业务配置（商品图片数、订单超时时间）
- **content** - 内容审核配置（敏感词过滤、图片审核）

---

## 开发注意事项

### 1. 图片处理
- 使用阿里云 OSS 图片处理服务自动生成多尺寸图片
- 图片上传限制：最大 5MB，支持 JPG/PNG/WebP
- 通过 URL 参数实现不同尺寸：`?x-oss-process=image/resize,w_800`

### 2. 敏感词过滤
- 发布商品、发送消息前需要检测敏感词
- 使用 `sensitive_word` 表维护敏感词列表
- 支持禁止词、敏感词、替换词三种类型

### 3. 安全要求
- 用户密码使用 BCrypt 加密存储
- 防止 SQL 注入、XSS 攻击
- 学号实名认证，防止虚假账户
- 敏感信息脱敏处理

### 4. 性能要求
- 页面加载时间 < 2秒
- 支持 500+ 用户并发
- 系统可用性 99.9% 以上
- 使用 Redis 缓存热点数据

### 5. 代码规范
- 使用 Lombok 简化代码
- RESTful API 设计规范
- 统一异常处理
- 完善的日志记录
- 操作日志审计（operation_log 表）

### 6. 数据库索引
- 为高频查询字段创建索引
- 唯一索引：username、order_no
- 复合索引：user_id + product_id（收藏表）
- 全文索引：title + description（商品搜索）

---

---


## 常见问题

### Q: 如何添加新的配置项？
A: 在 `system_config` 表中插入新记录，设置 `config_key`、`config_value`、`config_type` 等字段。公开配置前端可通过 `/api/public/config` 接口获取。

### Q: 商品图片如何处理？
A: 使用独立的 `product_image` 表，每张图片记录包含原图、中等图、缩略图三个 URL。使用 `is_cover` 字段标识封面图。

### Q: 如何实现即时通讯？
A: 使用 WebSocket 实现实时通信。会话管理使用 `conversation` 表，消息存储在 `message` 表。支持文本、图片、商品卡片、订单卡片等多种消息类型。

### Q: 敏感词过滤如何实现？
A: 在 `sensitive_word` 表中维护敏感词列表。发布商品或发送消息时，调用检测接口过滤违规内容。

---

## 参考文档

详细需求请参阅项目根目录下的 `PRD-校园二手交易与共享平台.md` 文档。
